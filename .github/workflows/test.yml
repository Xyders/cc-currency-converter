name: Test and Deploy

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run typecheck

      - name: Run tests
        run: npm run test

      - name: Run coverage
        run: npm run test:coverage

  deploy:
    name: Deploy to Cloudflare Workers
    needs: test
    if: success()
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [preview, production]
        include:
          - environment: preview
            deploy_condition: ${{ github.event_name == 'pull_request' }}
            env_name: preview
            worker_name: currency-converter-api-pr-${{ github.event.number }}
            route: pr-${{ github.event.number }}.currency-converter-api.poplar.academy/*
            base_url: https://pr-${{ github.event.number }}.currency-converter-api.poplar.academy
            use_custom_domain: false
          - environment: production
            deploy_condition: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
            env_name: production
            worker_name: currency-converter-api
            domain: currency-converter-api.poplar.academy
            base_url: https://currency-converter-api.poplar.academy
            use_custom_domain: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Deploy to Cloudflare Workers
        if: matrix.deploy_condition
        run: |
          echo "Deploy condition: ${{ matrix.deploy_condition }}"
          echo "Environment: ${{ matrix.environment }}"
          echo "Event name: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          set -x
          if [ "${{ matrix.use_custom_domain }}" = "true" ]; then
            npx wrangler deploy --env ${{ matrix.env_name }} --name "${{ matrix.worker_name }}" --domain "${{ matrix.domain }}"
          else
            npx wrangler deploy --env ${{ matrix.env_name }} --name "${{ matrix.worker_name }}" --routes "${{ matrix.route }}"
          fi
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Verify service binding via Cloudflare API
        if: matrix.deploy_condition
        run: |
          echo "Verifying service binding for worker: ${{ matrix.worker_name }}"

          # Use a temporary file to store the response
          response_file=$(mktemp)

          # Fetch worker script details with explicit error handling
          http_code=$(curl -s -w "%{http_code}" -o "$response_file" \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            -H "Content-Type: application/json" \
            "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/workers/scripts/${{ matrix.worker_name }}")

          # Check if curl succeeded and we got a 2xx response
          if [ $? -ne 0 ]; then
            echo "❌ Failed to fetch worker details from Cloudflare API"
            rm -f "$response_file"
            exit 1
          fi

          if [ "${http_code:0:1}" != "2" ]; then
            echo "❌ Cloudflare API returned HTTP $http_code"
            echo "Response content:"
            cat "$response_file"
            rm -f "$response_file"
            exit 1
          fi

          # Validate JSON response
          if ! jq '.' "$response_file" > /dev/null 2>&1; then
            echo "❌ Cloudflare API returned invalid JSON response"
            echo "Raw response:"
            cat "$response_file"
            rm -f "$response_file"
            exit 1
          fi

          # Check for service binding with explicit exit code handling
          jq_exit=0
          jq -e '.result.bindings[]? | select(.type=="service" and .name=="akamaiService")' "$response_file" > /dev/null || jq_exit=$?

          case $jq_exit in
            0)
              echo "✅ Service binding 'akamaiService' found in worker configuration"
              rm -f "$response_file"
              ;;
            1)
              echo "❌ Service binding 'akamaiService' not found in worker configuration"
              echo "Worker configuration details:"
              jq '.' "$response_file"
              rm -f "$response_file"
              exit 1
              ;;
            *)
              echo "❌ Error parsing JSON response (jq exit code: $jq_exit)"
              echo "Response content:"
              cat "$response_file"
              rm -f "$response_file"
              exit 1
              ;;
          esac
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Smoke test deployed API
        if: matrix.deploy_condition
        run: |
          echo "Testing API endpoints at ${{ matrix.base_url }}"
          # Wait a few seconds for deployment to propagate
          sleep 10
          # Debug DNS resolution
          echo "Testing DNS resolution for ${{ matrix.base_url }}"
          nslookup $(echo "${{ matrix.base_url }}" | sed 's|https://||') || true

          # Function to test endpoint with fallback from HTTPS to HTTP for preview
          test_endpoint() {
            local endpoint=$1
            local url_https="${{ matrix.base_url }}$endpoint"
            local url_http="http://$(echo "${{ matrix.base_url }}" | sed 's|https://||')$endpoint"

            echo "Testing: $endpoint"
            # Try HTTPS first
            if curl -f -s -o /dev/null -w "HTTPS: %{http_code}\n" "$url_https"; then
              return 0
            else
              local curl_exit=$?
              echo "HTTPS failed with exit code $curl_exit"
              # For preview environment, try HTTP as fallback
              if [ "${{ matrix.environment }}" = "preview" ]; then
                echo "Trying HTTP fallback for preview..."
                if curl -f -s -o /dev/null -w "HTTP: %{http_code}\n" "$url_http"; then
                  return 0
                else
                  echo "HTTP also failed"
                  return 1
                fi
              else
                return 1
              fi
            fi
          }

          # Test endpoints
          test_endpoint "/health" || echo "Health check failed"
          test_endpoint "/currencies" || echo "Currencies check failed"
          test_endpoint "/convert?from=USD&to=EUR&amount=100" || echo "Convert check failed"
          test_endpoint "/" || echo "Root check failed"

          echo "Smoke tests completed (some may have failed)"

      - name: Log production deployment URL
        if: matrix.environment == 'production' && matrix.deploy_condition
        run: |
          echo "Production deployment successful!"
          echo "URL: ${{ matrix.base_url }}"

      - name: Post preview URL as PR comment
        if: matrix.environment == 'preview' && matrix.deploy_condition
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: preview-deployment
          message: |
            ## Preview Deployment

            Your changes have been deployed to a preview environment.

            **URL**: https://pr-${{ github.event.number }}.currency-converter-api.poplar.academy

            **Endpoints**:
            - `GET /health` - Health check
            - `GET /currencies` - List available currencies
            - `GET /convert?from=USD&to=EUR&amount=100` - Convert currency

            This deployment will be automatically cleaned up when the PR is closed.