name: Test and Deploy

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run typecheck

      - name: Run tests
        run: npm run test

      - name: Run coverage
        run: npm run test:coverage

  deploy:
    name: Deploy to Cloudflare Workers
    needs: test
    if: success()
    runs-on: ubuntu-latest
    strategy:
      matrix:
        environment: [preview, production]
        include:
          - environment: preview
            deploy_condition: github.event_name == 'pull_request'
            env_name: preview
            worker_name: currency-converter-api-pr-${{ github.event.number }}
            route: pr-${{ github.event.number }}.currency-converter-api.poplar.academy/*
            base_url: https://pr-${{ github.event.number }}.currency-converter-api.poplar.academy
          - environment: production
            deploy_condition: github.event_name == 'push' && github.ref == 'refs/heads/main'
            env_name: production
            worker_name: currency-converter-api
            route: currency-converter-api.poplar.academy/*
            base_url: https://currency-converter-api.poplar.academy
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Deploy to Cloudflare Workers
        if: matrix.deploy_condition
        run: |
          npx wrangler deploy --env ${{ matrix.env_name }} --name "${{ matrix.worker_name }}" --routes "${{ matrix.route }}"
        env:
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}

      - name: Smoke test deployed API
        if: matrix.deploy_condition
        run: |
          echo "Testing API endpoints at ${{ matrix.base_url }}"
          # Wait a few seconds for deployment to propagate
          sleep 5
          # Test health endpoint
          curl -f -s -o /dev/null -w "Health: %{http_code}\n" ${{ matrix.base_url }}/health
          # Test currencies endpoint
          curl -f -s -o /dev/null -w "Currencies: %{http_code}\n" ${{ matrix.base_url }}/currencies
          # Test convert endpoint with sample values (USD to EUR)
          curl -f -s -o /dev/null -w "Convert: %{http_code}\n" "${{ matrix.base_url }}/convert?from=USD&to=EUR&amount=100"
          # Test root endpoint
          curl -f -s -o /dev/null -w "Root: %{http_code}\n" ${{ matrix.base_url }}/
          echo "All smoke tests passed"

      - name: Log production deployment URL
        if: matrix.environment == 'production' && matrix.deploy_condition
        run: |
          echo "Production deployment successful!"
          echo "URL: ${{ matrix.base_url }}"

      - name: Post preview URL as PR comment
        if: matrix.environment == 'preview' && matrix.deploy_condition
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: preview-deployment
          message: |
            ## Preview Deployment

            Your changes have been deployed to a preview environment.

            **URL**: https://pr-${{ github.event.number }}.currency-converter-api.poplar.academy

            **Endpoints**:
            - `GET /health` - Health check
            - `GET /currencies` - List available currencies
            - `GET /convert?from=USD&to=EUR&amount=100` - Convert currency

            This deployment will be automatically cleaned up when the PR is closed.